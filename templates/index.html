<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bybit期权链搜索工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container-fluid">
        <!-- 导航栏 -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-graph-up-arrow"></i>
                    Bybit期权链搜索工具
                </a>
                <div class="navbar-nav ms-auto">
                    <button class="btn btn-outline-light btn-sm" id="refreshDataBtn">
                        <i class="bi bi-arrow-clockwise"></i>
                        刷新数据
                    </button>
                </div>
            </div>
        </nav>

        <!-- 数据状态栏 -->
        <div class="container">
            <div class="alert alert-info mb-4" id="dataStatusBar">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-info-circle"></i>
                        <span id="dataStatusText">检查数据状态中...</span>
                    </div>
                    <div>
                        <small id="dataStatusDetails" class="text-muted"></small>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
            <!-- 导航标签 -->
            <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-panel" type="button" role="tab">
                        <i class="bi bi-search"></i>
                        期权搜索
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-panel" type="button" role="tab">
                        <i class="bi bi-robot"></i>
                        AI助手
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="strategy-tab" data-bs-toggle="tab" data-bs-target="#strategy-panel" type="button" role="tab">
                        <i class="bi bi-diagram-3"></i>
                        策略管理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trades-tab" data-bs-toggle="tab" data-bs-target="#trades-panel" type="button" role="tab">
                        <i class="bi bi-journal-text"></i>
                        交易记录
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-panel" type="button" role="tab">
                        <i class="bi bi-sliders2"></i>
                        API设置
                    </button>
                </li>
            </ul>

            <!-- 标签内容 -->
            <div class="tab-content" id="mainTabsContent">
                <!-- 期权搜索面板 -->
                <div class="tab-pane fade show active" id="search-panel" role="tabpanel">
                    <!-- 搜索表单 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-search"></i>
                                期权搜索
                            </h5>
                        </div>
                <div class="card-body">
                    <form id="searchForm">
                        <div class="row g-3">
                            <!-- 基础币种 -->
                            <div class="col-md-3">
                                <label for="baseCoin" class="form-label">基础币种</label>
                                <select class="form-select" id="baseCoin" name="base_coin">
                                    <option value="BTC" selected>BTC</option>
                                    <option value="ETH">ETH</option>
                                </select>
                            </div>

                            <!-- 期权方向 -->
                            <div class="col-md-3">
                                <label for="direction" class="form-label">期权方向</label>
                                <select class="form-select" id="direction" name="direction">
                                    <option value="Call" selected>看涨期权 (Call)</option>
                                    <option value="Put">看跌期权 (Put)</option>
                                </select>
                            </div>

                            <!-- 执行价格 -->
                            <div class="col-md-3">
                                <label for="targetPrice" class="form-label">执行价格 (Strike Price)</label>
                                <div class="input-group">
                                    <select class="form-select" id="targetPrice" name="target_price" required>
                                        <option value="">选择执行价格...</option>
                                    </select>
                                    <button class="btn btn-outline-secondary" type="button" id="loadStrikePrices" title="加载执行价格">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    当前价格: <span id="currentPrice" class="text-primary">加载中...</span><br>
                                    <small class="text-muted">选择期权合约的执行价格（行权价）</small>
                                </div>
                            </div>

                            <!-- 天数 -->
                            <div class="col-md-3">
                                <label for="days" class="form-label">到期天数</label>
                                <input type="number" class="form-control" id="days" name="days" 
                                       placeholder="例如: 7" min="0" max="365" required>
                                <div class="form-text">
                                    搜索范围: ±10天
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-search"></i>
                                    搜索期权
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="getExpiryDates">
                                    <i class="bi bi-calendar"></i>
                                    查看可用日期
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 加载指示器 -->
            <div id="loadingIndicator" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <p class="mt-2">正在搜索期权数据...</p>
            </div>

            <!-- 搜索结果 -->
            <div id="searchResults" class="d-none">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-list-ul"></i>
                            搜索结果
                        </h5>
                        <span id="resultCount" class="badge bg-primary"></span>
                    </div>
                    <div class="card-body">
                        <!-- 搜索参数摘要 -->
                        <div id="searchSummary" class="alert alert-info mb-3"></div>
                        
                        <!-- 结果表格 -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>合约代码</th>
                                        <th>执行价格</th>
                                        <th>价格差距</th>
                                        <th>价格差距%</th>
                                        <th>到期日期</th>
                                        <th>剩余天数</th>
                                        <th>买入价</th>
                                        <th>卖出价</th>
                                        <th>标记价格</th>
                                        <th>24h成交量</th>
                                        <th>持仓量</th>
                                        <th>隐含波动率</th>
                                        <th>Delta</th>
                                        <th>价内/价外</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 错误信息 -->
            <div id="errorMessage" class="alert alert-danger d-none">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="errorText"></span>
            </div>

            <!-- 关注列表 -->
            <div id="watchlistSection" class="d-none mt-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-star-fill text-warning"></i>
                            关注列表
                        </h5>
                        <div>
                            <span id="watchlistCount" class="badge bg-warning text-dark me-2"></span>
                            <button type="button" class="btn btn-outline-danger btn-sm" id="clearWatchlistBtn">
                                <i class="bi bi-trash"></i>
                                清空关注
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="watchlistEmpty" class="text-center text-muted">
                            <i class="bi bi-bookmark"></i>
                            <p class="mb-0">还没有关注的期权，请在搜索结果中点击“关注”按钮。</p>
                        </div>
                        <div class="table-responsive d-none" id="watchlistTableWrapper">
                            <table class="table table-sm align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>合约代码</th>
                                        <th>执行价格</th>
                                        <th>到期日</th>
                                        <th>天数</th>
                                        <th>买/卖价</th>
                                        <th>标记价格</th>
                                        <th>IV</th>
                                        <th>Delta</th>
                                        <th>价内/价外</th>
                                        <th>添加时间</th>
                                    </tr>
                                </thead>
                                <tbody id="watchlistTable">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 可用日期模态框 -->
            <div class="modal fade" id="expiryDatesModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">可用到期日期</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="expiryDatesList">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">加载中...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        </div>
                    </div>
                </div>
            </div>
                </div>

                <!-- AI助手面板 -->
                <div class="tab-pane fade" id="ai-panel" role="tabpanel">
                    <!-- AI服务选择 -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-gear"></i>
                                AI服务配置
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="aiProvider" class="form-label">选择AI服务</label>
                                    <select class="form-select" id="aiProvider">
                                        <option value="claude">Claude (Anthropic)</option>
                                        <option value="ollama">Ollama (本地)</option>
                                        <option value="deepseek">DeepSeek</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="aiApiKey" class="form-label">API Key</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="aiApiKey" placeholder="输入API密钥">
                                        <button class="btn btn-outline-secondary" type="button" id="toggleApiKey">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">&nbsp;</label>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" id="testConnection">
                                            <i class="bi bi-plug"></i>
                                            测试
                                        </button>
                                        <button type="button" class="btn btn-success" id="saveConfig">
                                            <i class="bi bi-check"></i>
                                            保存
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div id="aiConnectionStatus" class="alert alert-info d-none">
                                    <i class="bi bi-info-circle"></i>
                                    <span id="aiStatusText">请配置并测试AI服务连接</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI对话区域 -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-chat-dots"></i>
                                AI对话助手
                            </h5>
                            <div>
                                <button type="button" class="btn btn-outline-primary btn-sm" id="analyzeOptions">
                                    <i class="bi bi-graph-up"></i>
                                    分析期权
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="clearChat">
                                    <i class="bi bi-trash"></i>
                                    清除历史
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- 对话显示区域 -->
                            <div id="chatMessages" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto;">
                                <div class="text-center text-muted">
                                    <i class="bi bi-robot"></i>
                                    <p>欢迎使用AI期权分析助手！</p>
                                    <p>您可以:</p>
                                    <ul class="list-unstyled">
                                        <li>• 询问期权交易策略</li>
                                        <li>• 分析当前搜索的期权数据</li>
                                        <li>• 获取市场建议和风险评估</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- 消息输入区域 -->
                            <div class="input-group">
                                <input type="text" class="form-control" id="chatInput" placeholder="输入您的问题..." disabled>
                                <button class="btn btn-primary" type="button" id="sendMessage" disabled>
                                    <i class="bi bi-send"></i>
                                    发送
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 任务清单 -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-list-check"></i>
                                AI推荐任务清单
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="aiTasks">
                                <div class="text-center text-muted">
                                    <i class="bi bi-clipboard"></i>
                                    <p>AI分析完成后将显示推荐的交易任务</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 策略管理面板 -->
                <div class="tab-pane fade" id="strategy-panel" role="tabpanel">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-diagram-3"></i>
                                交易策略
                            </h5>
                            <button class="btn btn-primary btn-sm" id="createStrategyBtn">
                                <i class="bi bi-plus"></i>
                                新建策略
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="strategyEmpty" class="text-center text-muted d-none">
                                <i class="bi bi-collection"></i>
                                <p class="mb-0">暂无策略，点击“新建策略”开始配置。</p>
                            </div>
                            <div class="table-responsive d-none" id="strategyTableWrapper">
                                <table class="table table-hover align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>策略名称</th>
                                            <th>状态</th>
                                            <th>Level数</th>
                                            <th>更新时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="strategyTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card d-none" id="strategyDetailCard">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="card-title mb-0" id="strategyDetailTitle"></h5>
                                <small class="text-muted" id="strategyDetailDescription"></small>
                            </div>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-secondary" id="editStrategyBtn">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                <button class="btn btn-outline-warning" id="pauseStrategyBtn"></button>
                                <button class="btn btn-outline-danger" id="deleteStrategyBtn">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="fw-bold">Level 状态</h6>
                            <div class="table-responsive">
                                <table class="table table-sm align-middle" id="levelStatusTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Level ID</th>
                                            <th>期权</th>
                                            <th>方向</th>
                                            <th>触发类型</th>
                                            <th>状态</th>
                                            <th>监控任务</th>
                                            <th>创建时间</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 交易记录面板 -->
                <div class="tab-pane fade" id="trades-panel" role="tabpanel">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-clipboard2-data"></i>
                                交易记录
                            </h5>
                            <button class="btn btn-outline-secondary btn-sm" id="refreshTradesBtn">
                                <i class="bi bi-arrow-clockwise"></i>
                                刷新
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>时间</th>
                                            <th>策略</th>
                                            <th>Level</th>
                                            <th>类型</th>
                                            <th>期权</th>
                                            <th>方向</th>
                                            <th>数量</th>
                                            <th>触发价</th>
                                            <th>目标价</th>
                                            <th>结果</th>
                                            <th>信息</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tradeLogTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 设置面板 -->
                <div class="tab-pane fade" id="settings-panel" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-sliders2"></i>
                                Bybit API 设置
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="apiSettingsForm" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="apiKeyInput" placeholder="请输入 Bybit API Key" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">API Secret</label>
                                    <input type="password" class="form-control" id="apiSecretInput" placeholder="请输入 Bybit API Secret" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">交易环境</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="environmentOptions" id="envTestnet" value="testnet" checked>
                                        <label class="form-check-label" for="envTestnet">
                                            测试网
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="environmentOptions" id="envLive" value="live">
                                        <label class="form-check-label" for="envLive">
                                            实盘
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Price Monitor 服务地址</label>
                                    <input type="text" class="form-control" id="priceMonitorInput" placeholder="http://localhost:8888">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Webhook 基地址</label>
                                    <input type="text" class="form-control" id="webhookBaseInput" placeholder="http://localhost:8080">
                                </div>
                            </form>
                        </div>
                        <div class="card-footer d-flex justify-content-between align-items-center">
                            <div class="text-muted small" id="settingsStatus"></div>
                            <button type="button" class="btn btn-primary" id="saveSettingsBtn">
                                <i class="bi bi-save"></i>
                                保存设置
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-light text-center text-muted py-3 mt-5">
        <div class="container">
            <p class="mb-0">© 2024 Bybit期权链搜索工具 | 基于Bybit API开发</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai_assistant.js') }}"></script>
    <script src="{{ url_for('static', filename='js/strategy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>

    <!-- 策略编辑模态框 -->
    <div class="modal fade" id="strategyModal" tabindex="-1" aria-labelledby="strategyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="strategyModalLabel">策略配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="strategyForm">
                        <input type="hidden" id="strategyId">
                        <div class="mb-3">
                            <label for="strategyName" class="form-label">策略名称</label>
                            <input type="text" class="form-control" id="strategyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="strategyDescription" class="form-label">策略说明</label>
                            <textarea class="form-control" id="strategyDescription" rows="2"></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Levels</h6>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addLevelBtn">
                                <i class="bi bi-plus"></i>
                                添加Level
                            </button>
                        </div>
                        <div id="levelsContainer" class="gy-3"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveStrategyBtn">保存策略</button>
                </div>
            </div>
        </div>
    </div>

    <template id="levelTemplate">
        <div class="card level-item mb-3" data-level-id="">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Level <span class="level-index"></span></h6>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-level-btn">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">期权</label>
                        <select class="form-select level-symbol" required></select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">方向</label>
                        <select class="form-select level-side">
                            <option value="buy">买入</option>
                            <option value="sell">卖出</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">数量</label>
                        <input type="text" class="form-control level-quantity" value="1" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">触发类型</label>
                        <select class="form-select level-trigger-type">
                            <option value="immediate">立即执行</option>
                            <option value="existing_position">使用现有仓位</option>
                            <option value="conditional">期权价格触发</option>
                            <option value="btc_price">BTC现货触发</option>
                            <option value="level_close">Level平仓触发</option>
                        </select>
                    </div>
                    <div class="col-md-4 conditional-field d-none">
                        <label class="form-label">触发价格</label>
                        <input type="number" step="0.0001" class="form-control level-trigger-price">
                    </div>
                    <div class="col-md-4 linked-field d-none">
                        <label class="form-label">依赖Level</label>
                        <select class="form-select level-linked-level"></select>
                    </div>
                    <div class="col-md-4 linked-field d-none">
                        <label class="form-label">触发事件</label>
                        <select class="form-select level-linked-event">
                            <option value="ANY">任意平仓</option>
                            <option value="TAKE_PROFIT">止盈</option>
                            <option value="STOP_LOSS">止损</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">止盈价格</label>
                        <input type="number" step="0.0001" class="form-control level-take-profit">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">止损价格</label>
                        <input type="number" step="0.0001" class="form-control level-stop-loss">
                    </div>
                </div>
            </div>
        </div>
    </template>
</body>
</html>
